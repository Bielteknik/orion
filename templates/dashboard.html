{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Dashboard: {{ device.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="dropdown">
        <h2 class="page-title dropdown-toggle" type="button" data-bs-toggle="dropdown">
           <i class="fas fa-broadcast-tower me-2"></i> {{ device.name }}
        </h2>
        <ul class="dropdown-menu">
            {% for nav_device in all_devices_for_nav %}
            <li><a class="dropdown-item" href="{% url 'dashboard' device_id=nav_device.id %}">{{ nav_device.name }}</a></li>
            {% endfor %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'stations' %}">Tüm İstasyonlar...</a></li>
        </ul>
    </div>
    <div style="color: var(--text-light); font-weight: 500;">
        <i class="fas fa-clock me-2"></i><span id="currentTime"></span>
    </div>
</div>

<!-- YENİ ve DOĞRU GRID YAPISI -->
<div class="row">
    <!-- Sol Taraf: 2x2 Sensör Kartları -->
    <div class="col-lg-4">
        <div class="row">
            {% for sensor in device.sensors.all %}
                {% if forloop.counter <= 4 %} {# Sadece ilk 4 sensörü bu alanda göster #}
                <div class="col-md-6 mb-4">
                    <div class="glass-card h-100 text-center sensor-detail-trigger" style="cursor: pointer;" data-sensor-id="{{ sensor.id }}">
                        <h5 class="mb-3 text-truncate">{{ sensor.name }}</h5>
                        {% with reading=sensor_readings|get_item:sensor.id %}
                            {% if reading and reading.value %}
                                {% for key, value in reading.value.items %}
                                    {% if forloop.first %}
                                        <h2 class="display-6 fw-bold">
                                            {{ value|floatformat:1 }}
                                            <small class="fs-5 text-muted">
                                            {% if 'temperature' in key %}°C{% elif 'humidity' in key %}%{% elif 'distance' in key %}cm{% elif 'weight' in key %}kg{% endif %}
                                            </small>
                                        </h2>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <h2 class="display-6 fw-bold text-muted">-</h2>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Sağ Taraf: Kamera Alanı -->
    <div class="col-lg-8">
        <div class="glass-card h-100 d-flex flex-column">
        {% if main_camera %}
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-bold">{{ main_camera.name }}</div>
                <div>
                    <button class="btn btn-sm btn-success play-stream-btn" data-status="stopped" data-feed-url="{% url 'camera-feed' main_camera.pk %}" data-target-id="main-camera-feed"><i class="fas fa-play me-2"></i>Başlat</button>
                    <span class="badge bg-secondary ms-2">DURUM</span>
                </div>
            </div>
            <div id="main-camera-feed" class="bg-dark rounded mb-3 position-relative flex-grow-1">
                 <div class="h-100 d-flex flex-column align-items-center justify-content-center text-white text-center">
                    <i class="fas fa-play-circle fa-4x mb-3"></i> <p>Canlı Yayını Başlat</p>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <span class="badge bg-info me-2">Bugün Çekilen: {{ captures_today_count }}</span>
                <button class="btn btn-sm btn-outline-primary" disabled><i class="fas fa-images me-2"></i>Galeri</button>
            </div>
        {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 text-muted">Bu istasyona atanmış kamera yok.</div>
        {% endif %}
        </div>
    </div>
</div>

<!-- Alt Kısım: Sensör Verileri Listesi -->
<div class="glass-card mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Sensör Verileri Listesi</h5>
        <div>
            <input type="date" class="form-control form-control-sm d-inline-block" style="width: auto;">
            <button class="btn btn-sm btn-primary ms-2" disabled>Ara</button>
        </div>
    </div>
    <div class="table-responsive" style="max-height: 400px;">
        <table class="table table-hover">
            <thead><tr><th>Zaman</th><th>Sensör</th><th>Veri</th></tr></thead>
            <tbody>
                {% for reading in reading_history %}
                <tr>
                    <td>{{ reading.timestamp|date:"d.m.Y H:i:s" }}</td>
                    <td>{{ reading.sensor.name }}</td>
                    <td><code>{{ reading.value|safe }}</code></td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted">Geçmiş ölçüm verisi yok.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- YENİ: Sensör Detay Modal'ı -->
<div class="modal fade" id="sensorDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sensorModalTitle">Sensör Detayları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sensorModalBody">
                <p class="text-center">Yükleniyor...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Saat
    function updateTime() { $('#currentTime').text(new Date().toLocaleString('tr-TR')); }
    setInterval(updateTime, 1000); updateTime();

    // Kamera başlat/durdur
    $('.play-stream-btn').on('click', function() {
        const btn = $(this);
        const targetId = btn.data('target-id');
        const container = $(`#${targetId}`);
        if (btn.data('status') === 'stopped') {
            container.html(`<img src="${btn.data('feed-url')}" width="100%" height="100%" style="object-fit: cover;">`);
            btn.data('status', 'playing').removeClass('btn-success').addClass('btn-danger').html('<i class="fas fa-stop me-2"></i>Durdur');
        } else {
            container.html('<div class="h-100 d-flex flex-column align-items-center justify-content-center text-white text-center"><i class="fas fa-play-circle fa-4x mb-3"></i><p>Yayın Durduruldu</p></div>');
            btn.data('status', 'stopped').removeClass('btn-danger').addClass('btn-success').html('<i class="fas fa-play me-2"></i>Başlat');
        }
    });

    // Sensör Detay Modalını aç
    const sensorModal = new bootstrap.Modal(document.getElementById('sensorDetailModal'));
    $('.sensor-detail-trigger').on('click', function() {
        const sensorId = $(this).data('sensor-id');
        $('#sensorModalBody').html('<p class="text-center">Yükleniyor...</p>');
        sensorModal.show();
        // NOT: Buraya AJAX ile sunucudan sensörün detaylarını ve geçmiş verilerini
        // çekecek bir kod yazacağız (bir sonraki adımda).
        // Şimdilik sadece modal'ı açıyoruz.
        setTimeout(() => {
             $('#sensorModalBody').html('<p class="text-center">Bu sensörün detaylı istatistikleri ve grafiği burada gösterilecek.</p>');
        }, 1000);
    });
});
</script>
{% endblock %}