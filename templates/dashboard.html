{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Dashboard: {{ device.name }}{% endblock %}

{% block content %}
<!-- Hata/Başarı Bildirimleri için Sağ Üst Köşede Görünmez Alan -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="mainToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
    </div>
</div>

<!-- Sayfa Başlığı ve Saat -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="dropdown">
        <h2 class="page-title dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="cursor: pointer;">
           <i class="fas fa-broadcast-tower me-2"></i> {{ device.name }}
        </h2>
        <ul class="dropdown-menu">
            {% for nav_device in all_devices_for_nav %}
            <li><a class="dropdown-item" href="{% url 'dashboard' device_id=nav_device.id %}">{{ nav_device.name }}</a></li>
            {% endfor %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'stations' %}">Tüm İstasyonlar...</a></li>
        </ul>
    </div>
    <div style="color: var(--text-light); font-weight: 500;">
        <i class="fas fa-clock me-2"></i><span id="currentTime"></span>
    </div>
</div>

<!-- Ana Grid Yapısı -->
<div class="row">
    <!-- Sol Taraf: Gelişmiş Sensör Kartları -->
    <div class="col-lg-4">
        <div class="row">
            {% for card_info in sensor_cards %}
                <div class="col-md-6 col-12 mb-4">
                    {% if card_info %}
                        <div class="sensor-card {% if not card_info.sensor.is_active %}opacity-50{% endif %}" style="cursor: pointer;"
                             onclick="openSensorDetailModal('{{ card_info.sensor.id }}')">
                            <div class="row">
                                <div class="col-8">
                                    <h6 class="text-truncate" title="{{ card_info.sensor.name }}">{{ card_info.sensor.name }}</h6>
                                    {% with reading=card_info.reading %}
                                        {% if reading and reading.value %}
                                            {% for key, value in reading.value.items %}
                                                {% if forloop.first %}
                                                    <h3 class="fw-bold">
                                                        {{ value|floatformat:1 }}
                                                        <small class="text-muted fs-6">
                                                            {% if 'temp' in key %}°C{% elif 'hum' in key %}%{% elif 'dist' in key %}cm{% elif 'wei' in key %}kg{% endif %}
                                                        </small>
                                                    </h3>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <h3 class="fw-bold">-</h3>
                                        {% endif %}
                                    {% endwith %}
                                    <small class="text-muted">{{ card_info.sensor.device.name }}</small>
                                </div>
                                <div class="col-4 d-flex flex-column align-items-end justify-content-between">
                                    {% if card_info.sensor.is_active %}
                                        <span class="badge bg-success">Aktif</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Pasif</span>
                                    {% endif %}
                                    <i class="fas fa-thermometer-half fa-2x text-muted mt-2"></i>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="glass-card h-100 d-none d-md-block" style="min-height: 150px; border-style: dashed; background: rgba(255, 255, 255, 0.05);"></div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Sağ Taraf: Kamera Alanı -->
    <div class="col-lg-8">
        <div class="glass-card h-100 d-flex flex-column">
        {% if main_camera %}
            <div id="main-camera-feed" class="bg-dark rounded mb-3 position-relative flex-grow-1" style="min-height: 400px;">
                <div class="h-100 camera-overlay d-flex flex-column align-items-center justify-content-center text-white text-center" style="cursor: pointer;">
                    <i class="fas fa-play-circle fa-4x mb-3"></i>
                    <p>{{ main_camera.name }} - Canlı Yayını Başlat</p>
                </div>
                <div class="camera-controls position-absolute bottom-0 start-0 w-100 p-3 d-flex justify-content-start align-items-center" style="background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); display: none;">
                    <button class="btn btn-dark btn-sm me-2 play-toggle-btn" title="Durdur"><i class="fas fa-pause"></i></button>
                    <button class="btn btn-dark btn-sm capture-photo-btn" title="Fotoğraf Çek"><i class="fas fa-camera"></i></button>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <span class="badge bg-info me-2">Bugün Çekilen: {{ captures_today_count }}</span>
                <button class="btn btn-sm btn-outline-primary" disabled><i class="fas fa-images me-2"></i>Galeri</button>
            </div>
        {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 text-muted">Bu istasyona atanmış kamera yok.</div>
        {% endif %}
        </div>
    </div>
</div>

<!-- Alt Kısım: Sensör Verileri Listesi -->
<div class="glass-card mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Sensör Verileri Listesi</h5>
        <form method="get" class="d-flex align-items-center">
            <input type="date" name="filter_date" class="form-control form-control-sm" style="width: auto;" value="{{ filtered_date|default:today_date }}">
            <button type="submit" class="btn btn-sm btn-primary ms-2">Ara</button>
        </form>
    </div>
    <div class="table-responsive" style="max-height: 400px;">
        <table class="table table-hover">
            <thead><tr><th>Zaman</th><th>Sensör</th><th>Veri</th></tr></thead>
            <tbody>
                {% for reading in reading_history %}
                <tr>
                    <td>{{ reading.timestamp|date:"d.m.Y H:i:s" }}</td>
                    <td>{{ reading.sensor.name }}</td>
                    <td><code>{{ reading.value|safe }}</code></td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted">Geçmiş ölçüm verisi yok.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Sensör Detay Modal'ı -->
<div class="modal fade" id="sensorDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sensorModalTitle">Sensör Detayları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sensorModalBody">
                <p class="text-center">Yükleniyor...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    
    // --- TEMEL İŞLEVLER ---
    function updateTime() {
        $('#currentTime').text(new Date().toLocaleString('tr-TR'));
    }
    setInterval(updateTime, 1000);
    updateTime();

    const mainToast = new bootstrap.Toast(document.getElementById('mainToast'));
    function showToast(title, message, isError = false) {
        $('#toastTitle').text(title);
        $('#toastBody').text(message);
        if (isError) {
            $('#mainToast .toast-header').removeClass('bg-success').addClass('bg-danger text-white');
        } else {
            $('#mainToast .toast-header').removeClass('bg-danger text-white').addClass('bg-success text-white');
        }
        mainToast.show();
    }
    
    // --- KAMERA KONTROLLERİ ---
    const cameraContainer = $('#main-camera-feed');
    const playOverlay = cameraContainer.find('.camera-overlay');
    const controlsOverlay = cameraContainer.find('.camera-controls');
    const playToggleButton = controlsOverlay.find('.play-toggle-btn');
    const captureButton = controlsOverlay.find('.capture-photo-btn');
    let streamActive = false;
    const feedUrl = "{% if main_camera %}{% url 'camera-feed' main_camera.pk %}{% endif %}";
    const csrftoken = '{{ csrf_token }}';

    function startStream() {
        if (streamActive || !feedUrl) return;
        
        playOverlay.hide();
        cameraContainer.append('<div id="stream-loader" class="h-100 d-flex align-items-center justify-content-center text-white"><div class="spinner-border"></div></div>');
        
        const img = new Image();
        img.id = 'camera-stream-img';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';

        img.onload = function() {
            $('#stream-loader').remove();
            cameraContainer.append(img);
            controlsOverlay.css('display', 'flex');
            playToggleButton.html('<i class="fas fa-pause"></i>').attr('title', 'Durdur');
            streamActive = true;
        };

        img.onerror = function() {
            $('#stream-loader').remove();
            fetch(feedUrl).then(r => r.text()).then(msg => {
                showToast("Kamera Hatası", msg || "Bilinmeyen bir hata oluştu.", true);
            }).catch(() => {
                showToast("Ağ Hatası", "Sunucuya ulaşılamıyor.", true);
            });
            stopStream(true);
  
      };
        img.src = feedUrl;
    }

    function stopStream(isError = false) {
        if (!streamActive) return;
        $('#camera-stream-img').remove();
        if (!isError) {
            playOverlay.show();
        }
        controlsOverlay.hide();
        playToggleButton.html('<i class="fas fa-play"></i>').attr('title', 'Oynat');
        streamActive = false;
    }
    
    playOverlay.on('click', startStream);
    playToggleButton.on('click', stopStream);

    captureButton.on('click', function() {
        const cameraId = "{{ main_camera.id }}";
        if (!cameraId) return;

        const btn = $(this);
        btn.html('<span class="spinner-border spinner-border-sm"></span>');
        
        $.ajax({
            url: `/api/v3/cameras/${cameraId}/capture_photo/`,
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            success: function() {
                showToast("Komut Gönderildi", "Fotoğraf çekme komutu gönderildi.", false);
                setTimeout(() => location.reload(), 3000);
            },
            error: function() { showToast("Hata", "Komut gönderilemedi.", true); },
            complete: function() { btn.html('<i class="fas fa-camera"></i>'); }
        });
    });
    
    // --- SENSÖR DETAY MODALI ---
    const sensorModal = new bootstrap.Modal(document.getElementById('sensorDetailModal'));
    let sensorDetailChart = null;

    window.openSensorDetailModal = function(sensorId) {
        $('#sensorModalBody').html('<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>');
        $('#sensorModalTitle').text('Yükleniyor...');
        sensorModal.show();
        
        // Sunucudan sensörün detay verilerini çek
        $.ajax({
            url: `/api/v3/sensors/${sensorId}/details/`,
            method: 'GET',
            success: function(data) {
                // Modal'ın içeriğini dinamik olarak oluştur
                const sensor = data.sensor_info;
                const stats = data.stats;
                const chartData = data.chart_data;

                // Anlık değerleri al (varsa)
                let latestValueHtml = '-';
                if (Object.keys(stats).length > 0) {
                    const firstKey = Object.keys(stats)[0];
                    if (stats[firstKey]) {
                       const lastReading = chartData[firstKey].slice(-1)[0];
                       if (lastReading) latestValueHtml = `${parseFloat(lastReading[`value__${firstKey}`]).toFixed(1)} ${getUnit(firstKey)}`;
                    }
                }
                
                let modalHtml = `
                    <div class="row">
                        <div class="col-md-6"><h6>Genel Bilgiler</h6><p><strong>Sensör ID:</strong> ${sensor.id}<br><strong>Tip:</strong> ${sensor.name}<br><strong>İstasyon:</strong> ${sensor.device_name}</p></div>
                        <div class="col-md-6"><h6>Anlık Değerler</h6><p><strong>Mevcut Değer:</strong> ${latestValueHtml}<br><strong>Minimum:</strong> -<br><strong>Maksimum:</strong> -<br><strong>Ortalama:</strong> -</p></div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>24 Saatlik Trend</h6>
                        <select class="form-select form-select-sm" style="width: auto;"><option>Son 24 Saat</option><option>Son 7 Gün</option></select>
                    </div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="sensorDetailChartCanvas"></canvas>
                    </div>
                `;
                $('#sensorModalBody').html(modalHtml);
                $('#sensorModalTitle').text(`${sensor.device_name} - ${sensor.name}`);
                
                // Grafiği çiz
                drawSensorDetailChart(chartData);
            },
            error: function() {
                $('#sensorModalBody').html('<div class="alert alert-danger">Veriler yüklenemedi.</div>');
            }
        });
    }

    function getUnit(key) {
        if (key.includes('temp')) return '°C';
        if (key.includes('hum')) return '%';
        if (key.includes('dist')) return 'cm';
        if (key.includes('wei')) return 'kg';
        return '';
    }

    function drawSensorDetailChart(chartData) {
        if (sensorDetailChart) sensorDetailChart.destroy();
        const ctx = document.getElementById('sensorDetailChartCanvas').getContext('2d');
        const datasets = [];
        const colors = ['#e74c3c', '#3498db'];
        let colorIndex = 0;

        for (const key in chartData) {
            datasets.push({
                label: key,
                data: chartData[key].map(d => ({ x: new Date(d.timestamp), y: d[`value__${key}`] })),
                borderColor: colors[colorIndex % colors.length],
                tension: 0.2, fill: true,
            });
            colorIndex++;
        }

        sensorDetailChart = new Chart(ctx, {
            type: 'line', data: { datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { tooltipFormat: 'dd.MM.yyyy HH:mm' } },
                    y: { title: { display: true, text: 'Değer' } }
                }
            }
        });
    }
});
</script>
{% endblock %}