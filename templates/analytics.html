{% extends 'base.html' %}
{% load static %}
{% block title %}Veri Analizi - {{ block.super }}{% endblock title %}

{% block content %}
<div id="analytics" class="page-content active">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title"><i class="fas fa-chart-line me-2"></i>Veri Analizi</h2>
    </div>

    <!-- Filtreleme Formu -->
    <div class="glass-card mb-4">
        <div class="row align-items-end">
            <div class="col-md-5">
                <label class="form-label">İstasyonlar ve Sensörler</label>
                <select id="sensor-select" class="form-select" multiple="multiple">
                    {% for device in all_devices %}
                        <optgroup label="{{ device.name }}">
                            {% for sensor in device.sensors.all %}
                                <option value="{{ sensor.id }}">{{ sensor.name }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label">Zaman Aralığı</label>
                <select id="period-select" class="form-select">
                    <option value="24h" selected>Son 24 Saat</option>
                    <option value="7d">Son 7 Gün</option>
                    <option value="30d">Son 30 Gün</option>
                </select>
            </div>
            <div class="col-md-2">
                <button id="update-chart-btn" class="btn btn-gradient w-100">
                    <i class="fas fa-sync-alt me-2"></i>Grafiği Güncelle
                </button>
            </div>
        </div>
    </div>

    <!-- Grafik Alanı -->
    <div class="chart-container">
        <div id="chart-placeholder" class="text-center text-muted py-5">
            <i class="fas fa-chart-line fa-3x mb-3"></i>
            <p>Grafiği görmek için lütfen yukarıdan sensör seçip 'Güncelle' butonuna basın.</p>
        </div>
        <canvas id="analyticsChart" style="display: none;"></canvas>
    </div>
</div>
{% endblock content %}

{% block extra_css %}
<!-- Select2 kütüphanesini çoklu seçim kutusu için ekliyoruz -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select2 kütüphanesini başlat
    $('#sensor-select').select2({
        theme: 'bootstrap-5',
        placeholder: 'Analiz için sensörleri seçin...',
        closeOnSelect: false,
    });

    let analyticsChart = null;
    const updateBtn = document.getElementById('update-chart-btn');
    const chartCanvas = document.getElementById('analyticsChart');
    const chartPlaceholder = document.getElementById('chart-placeholder');

    updateBtn.addEventListener('click', function() {
        const selectedSensors = $('#sensor-select').val();
        const selectedPeriod = $('#period-select').val();

        if (selectedSensors.length === 0) {
            alert('Lütfen en az bir sensör seçin.');
            return;
        }

        // API URL'ini oluştur
        const url = `/api/v3/analytics/data/?sensors=${selectedSensors.join(',')}&period=${selectedPeriod}`;
        
        // Butonu "Yükleniyor" durumuna getir
        updateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Yükleniyor...';
        updateBtn.disabled = true;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                    return;
                }
                
                chartPlaceholder.style.display = 'none';
                chartCanvas.style.display = 'block';

                // Grafik için verileri hazırla
                const datasets = [];
                const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#34495e'];
                let colorIndex = 0;
                
                // Her sensör verisi için ayrı bir 'dataset' oluştur
                for (const sensorId in data) {
                    const sensorData = data[sensorId];
                    // Gelen verideki farklı anahtarları (temperature, humidity, distance_cm, value) işle
                    for (const key in sensorData.readings[0].value) {
                        datasets.push({
                            label: `${sensorData.device} - ${sensorData.name} (${key})`,
                            data: sensorData.readings.map(r => ({
                                x: new Date(r.timestamp),
                                y: r.value[key]
                            })),
                            borderColor: colors[colorIndex % colors.length],
                            tension: 0.1,
                            fill: false,
                        });
                        colorIndex++;
                    }
                }
                
                // Grafiği çiz/güncelle
                drawChart(datasets);
            })
            .catch(error => {
                console.error('Grafik verisi çekilirken hata:', error);
                chartPlaceholder.innerHTML = '<div class="alert alert-danger">Grafik verileri yüklenemedi.</div>';
                chartPlaceholder.style.display = 'block';
                chartCanvas.style.display = 'none';
            })
            .finally(() => {
                // Butonu eski haline getir
                updateBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Grafiği Güncelle';
                updateBtn.disabled = false;
            });
    });

    function drawChart(datasets) {
        if (analyticsChart) {
            analyticsChart.destroy(); // Önceki grafiği temizle
        }
        
        analyticsChart = new Chart(chartCanvas, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'dd.MM.yyyy HH:mm',
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'dd MMM'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Zaman'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Değer'
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock extra_js %}