{% extends 'base.html' %}
{% load static %}
{% block title %}Veri Analizi - {{ block.super }}{% endblock title %}

{% block content %}
<div id="analytics" class="page-content active">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title"><i class="fas fa-chart-line me-2"></i>Veri Analizi</h2>
    </div>
    <div class="glass-card mb-4">
        <div class="row align-items-end">
            <div class="col-md-5">
                <label class="form-label">İstasyonlar ve Sensörler</label>
                <select id="sensor-select" class="form-select" multiple="multiple" style="width: 100%;">
                    {% for device in all_devices %}
                        <optgroup label="{{ device.name }}">
                            {% for sensor in device.sensors.all %}
                                <option value="{{ sensor.id }}">{{ sensor.name }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label">Zaman Aralığı</label>
                <select id="period-select" class="form-select">
                    <option value="24h" selected>Son 24 Saat</option>
                    <option value="7d">Son 7 Gün</option>
                    <option value="30d">Son 30 Gün</option>
                </select>
            </div>
            <div class="col-md-2">
                <button id="update-chart-btn" class="btn btn-gradient w-100"><i class="fas fa-sync-alt me-2"></i>Güncelle</button>
            </div>
        </div>
    </div>
    <div class="chart-container">
        <div id="chart-placeholder" class="text-center text-muted py-5">
            <i class="fas fa-chart-line fa-3x mb-3"></i>
            <p>Grafiği görmek için lütfen yukarıdan sensör seçip 'Güncelle' butonuna basın.</p>
        </div>
        <canvas id="analyticsChart" style="display: none;"></canvas>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#sensor-select').select2({
        theme: 'bootstrap-5',
        placeholder: 'Analiz için sensörleri seçin...',
        closeOnSelect: false,
    });

    let analyticsChart = null;
    const updateBtn = $('#update-chart-btn');
    const chartCanvas = $('#analyticsChart');
    const chartPlaceholder = $('#chart-placeholder');

    updateBtn.on('click', function() {
        const selectedSensors = $('#sensor-select').val();
        if (!selectedSensors || selectedSensors.length === 0) {
            alert('Lütfen en az bir sensör seçin.');
            return;
        }
        
        const selectedPeriod = $('#period-select').val();
        const url = `/api/v3/analytics/data/?sensors=${selectedSensors.join(',')}&period=${selectedPeriod}`;
        updateBtn.html('<span class="spinner-border spinner-border-sm"></span> Yükleniyor...').prop('disabled', true);

        $.ajax({
            url: url, method: 'GET',
            success: function(data) {
                chartPlaceholder.hide(); chartCanvas.show();
                const datasets = [];
                const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#34495e'];
                let colorIndex = 0;
                
                for (const sensorId in data) {
                    const sensorData = data[sensorId];
                    if (sensorData.readings.length > 0) {
                        for (const key in sensorData.readings[0].value) {
                            datasets.push({
                                label: `${sensorData.device} - ${sensorData.name} (${key})`,
                                data: sensorData.readings.map(r => ({x: new Date(r.timestamp), y: r.value[key]})),
                                borderColor: colors[colorIndex % colors.length],
                                tension: 0.1, fill: false,
                            });
                            colorIndex++;
                        }
                    }
                }
                drawChart(datasets);
            },
            error: function(error) { console.error("Hata:", error); alert('Grafik verisi çekilirken hata!'); },
            complete: function() { updateBtn.html('<i class="fas fa-sync-alt me-2"></i>Güncelle').prop('disabled', false); }
        });
    });

    function drawChart(datasets) {
        if (analyticsChart) analyticsChart.destroy();
        const ctx = document.getElementById('analyticsChart').getContext('2d');
        analyticsChart = new Chart(ctx, {
            type: 'line', data: { datasets: datasets },
            options: { responsive: true, scales: { x: { type: 'time', time: { tooltipFormat: 'dd.MM.yyyy HH:mm', displayFormats: { hour: 'HH:mm', day: 'dd MMM' } } }, y: { title: { display: true, text: 'Değer' } } } }
        });
    }
});
</script>
{% endblock %}